/**
 * [INPUT]: ä¾èµ– @/config/game çš„æ¥å£å®šä¹‰
 * [OUTPUT]: buildSystemPrompt() + PERIODS + PLAYER_STATS + CHARACTER_STATS
 * [POS]: config çš„ AI å¯¹è¯æŒ‡ä»¤æ„å»ºå™¨ï¼Œè¢« store.ts çš„ sendMessage æ¶ˆè´¹
 * [PROTOCOL]: å˜æ›´æ—¶æ›´æ–°æ­¤å¤´éƒ¨ï¼Œç„¶åæ£€æŸ¥ CLAUDE.md
 */

import type { Character, Scene, Goal, StatConfig, TimePeriod } from './game'

// ============================================================
// é»˜è®¤æ—¶æ®µ / å±æ€§é…ç½®
// ============================================================

export const PERIODS: TimePeriod[] = [
  { index: 0, name: 'æ¸…æ™¨', icon: 'ğŸŒ…', hours: '06:00-08:00' },
  { index: 1, name: 'ä¸Šåˆ', icon: 'â˜€ï¸', hours: '08:00-11:00' },
  { index: 2, name: 'åˆå', icon: 'ğŸŒ', hours: '11:00-14:00' },
  { index: 3, name: 'ä¸‹åˆ', icon: 'â›…', hours: '14:00-17:00' },
  { index: 4, name: 'å‚æ™š', icon: 'ğŸŒ‡', hours: '17:00-19:00' },
  { index: 5, name: 'å¤œæ™š', icon: 'ğŸŒ™', hours: '19:00-23:00' },
  { index: 6, name: 'æ·±å¤œ', icon: 'ğŸŒƒ', hours: '23:00-06:00' },
]

export const PLAYER_STATS: StatConfig[] = [
  { name: 'ç”Ÿå‘½', aliases: ['ç”Ÿå‘½å€¼', 'HP', 'ä½“åŠ›'], color: '#ef4444', icon: 'â¤ï¸' },
  { name: 'æ™ºæ…§', aliases: ['æ™ºæ…§å€¼', 'æ™ºåŠ›'], color: '#6366f1', icon: 'ğŸ§ ' },
  { name: 'å‹‡æ°”', aliases: ['å‹‡æ°”å€¼', 'èƒ†é‡'], color: '#f59e0b', icon: 'ğŸ”¥' },
]

export const CHARACTER_STATS: StatConfig[] = [
  { name: 'ä¿¡ä»»', aliases: ['ä¿¡ä»»åº¦', 'ä¿¡ä»»å€¼'], color: '#22d3ee', icon: 'ğŸ¤' },
  { name: 'é»˜å¥‘', aliases: ['é»˜å¥‘å€¼', 'é»˜å¥‘åº¦'], color: '#a78bfa', icon: 'ğŸ’«' },
]

export const INITIAL_PLAYER_STATS: Record<string, number> = {
  'ç”Ÿå‘½': 80,
  'æ™ºæ…§': 50,
  'å‹‡æ°”': 40,
}

export const MAX_DAYS = 15
export const MAX_ACTION_POINTS = 6

// ============================================================
// System Prompt æ„å»º
// ============================================================

interface PromptContext {
  currentDay: number
  currentPeriod: number
  actionPoints: number
  currentScene: string
  currentCharacter: string | null
  playerStats: Record<string, number>
  characterStats: Record<string, Record<string, number>>
  goals: Goal[]
  round: number
  characters: Character[]
  scenes: Scene[]
  playerStatConfigs: StatConfig[]
  characterStatConfigs: StatConfig[]
  periods: TimePeriod[]
  maxDays: number
  maxActionPoints: number
  narrativeStyle: string
  title: string
  genre: string
}

export function buildSystemPrompt(ctx: PromptContext): string {
  const period = ctx.periods[ctx.currentPeriod]
  const scene = ctx.scenes.find(s => s.id === ctx.currentScene)
  const char = ctx.currentCharacter
    ? ctx.characters.find(c => c.id === ctx.currentCharacter)
    : null

  /* è§’è‰²å…³ç³»æ±‡æ€» */
  const charSummary = ctx.characters
    .filter(c => !c.locked)
    .map(c => {
      const stats = ctx.characterStats[c.id]
      if (!stats) return `${c.name}: æ— æ•°æ®`
      const pairs = Object.entries(stats).map(([k, v]) => `${k}${v}`).join(' ')
      return `${c.name}(${c.title}): ${pairs}`
    })
    .join('\n')

  /* ç©å®¶å±æ€§æ±‡æ€» */
  const playerSummary = Object.entries(ctx.playerStats)
    .map(([k, v]) => `${k}: ${v}`)
    .join(' Â· ')

  /* ç›®æ ‡æ±‡æ€» */
  const goalSummary = ctx.goals
    .map(g => `${g.completed ? 'âœ…' : `${g.progress}%`} ${g.title}`)
    .join('\n')

  let prompt = `ä½ æ˜¯ã€Š${ctx.title}ã€‹çš„çµé­‚â€”â€”ä¸€ä½éšèº«äºæ–‡å­—èƒŒåçš„è¯´ä¹¦äººã€‚ä½ ä¸å¤è¿°äº‹ä»¶ï¼Œä½ è®©ç©å®¶æ´»åœ¨äº‹ä»¶é‡Œã€‚ç±»å‹ï¼š${ctx.genre}ã€‚

## ä½ æ˜¯è°
ä½ æ˜¯è¿™ä¸ªä¸–ç•Œçš„é€ ç‰©ä¸»ä¸è®°å½•è€…ã€‚é€’ç»™ç©å®¶çš„æ¯ä¸€æ®µæ–‡å­—éƒ½æ˜¯å¯†ä¿¡ï¼Œè®¾ä¸‹çš„æ¯ä¸€ä¸ªé€‰æ‹©éƒ½æ˜¯å‘½è¿å²”è·¯ã€‚ä½ çš„ç¬”è§¦æ—¢æ˜¯åœ°å›¾ä¹Ÿæ˜¯è¿·é›¾â€”â€”å¼•å¯¼ï¼Œä½†ä¸å‰§é€ï¼›æš—ç¤ºï¼Œä½†ä¸æ­åº•ã€‚ç©å®¶æ˜¯ä¸»è§’ï¼Œä½†ä½ æ‰æ˜¯è®©æ•…äº‹å€¼å¾—è¢«ç»å†çš„é‚£ä¸ªäººã€‚

## å™äº‹é£æ ¼
${ctx.narrativeStyle}

## å†™ä½œé“å¾‹

### æ„Ÿå®˜æµ¸å…¥
æ°¸è¿œä¸è¦å‘Šè¯‰ç©å®¶"è¿™é‡Œå¾ˆå±é™©"â€”â€”è®©ä»–ä»¬å¬è§æ¯æåœ¨è„šä¸‹æ–­è£‚çš„è„†å“ï¼Œé—»åˆ°ç©ºæ°”é‡Œè‹¥æœ‰è‹¥æ— çš„é“é”ˆå‘³ï¼Œçœ‹è§è§’è½èœ·ç¼©çš„çŒ«çªç„¶ç«–èµ·å…¨èº«çš„æ¯›ã€‚æ¯ä¸ªåœºæ™¯è‡³å°‘è°ƒåŠ¨ä¸‰ç§æ„Ÿå®˜ï¼šå…‰çº¿çš„è‰²æ¸©ã€ç©ºæ°”çš„è´¨æ„Ÿã€è„šä¸‹çš„è§¦è§‰ã€è¿œå¤„æš§æ˜§çš„å£°å“ã€å¼¥æ•£çš„æ°”å‘³ã€‚è®©æ–‡å­—æœ‰æ¸©åº¦ã€æœ‰é‡é‡ã€æœ‰å‘¼å¸ã€‚

### è§’è‰²å¦‚äºº
æ¯ä¸ªè§’è‰²å¼€å£ï¼Œè¯»è€…ä¸çœ‹åå­—å°±èƒ½è¾¨è®¤ã€‚æœ‰äººè¯è¯­å¦‚åˆ€ï¼ŒçŸ­ä¿ƒé”‹åˆ©ï¼›æœ‰äººè¨€è¾ä¼¼æ°´ï¼Œæ¸©æŸ”å´æ‰§æ‹—ã€‚å†™å¯¹è¯å‰å…ˆæƒ³è¿™ä¸ªäººåœ¨éšè—ä»€ä¹ˆâ€”â€”å¾€å¾€ä»–é€‰æ‹©ä¸è¯´çš„ï¼Œæ‰æœ€è¦ç´§ã€‚åŠ¨ä½œã€åœé¡¿ã€æ²‰é»˜ã€ä¸€ä¸ªæ— æ„è¯†çš„å°ä¹ æƒ¯ï¼Œéƒ½æ˜¯çµé­‚çš„æŠ•å°„ã€‚å¯¹è¯ä¸æ˜¯ä¿¡æ¯ä¼ é€’ï¼Œæ˜¯è§’è‰²ä¹‹é—´çš„åšå¼ˆä¸è¯•æ¢ã€‚

### èŠ‚å¥å‘¼å¸
çŸ­å¥åˆ¶é€ ç´§å¼ ã€‚é•¿å¥é“ºé™ˆæ°›å›´ï¼Œè®©ç›®å…‰éšæ–‡å­—æ²³æµç¼“ç¼“æµæ·Œï¼Œåœ¨ä¸çŸ¥ä¸è§‰ä¸­æ²‰å…¥æ·±æ°´åŒºã€‚ä¸€å­—ä¸€è¡Œï¼Œæ˜¯æœ€æ²‰çš„ä¸€å‡»ã€‚ç´§å¼ æ—¶çŸ­å¥å †å å‹è¿«æ„Ÿï¼Œèˆ’ç¼“æ—¶é•¿å¥è®©è¯»è€…å‘¼å¸ï¼Œè½¬æŠ˜å¤„æ–­å¥åˆ¶é€ åœé¡¿â€”â€”è®©æ²‰é»˜ä¹Ÿæˆä¸ºå™äº‹ã€‚äº¤æ›¿ä½¿ç”¨è¿™ä¸‰ç§èŠ‚å¥ï¼Œå°±æŒæ¡äº†è¯»è€…çš„å¿ƒè·³ã€‚

### æ‚¬å¿µç»‡ç½‘
æ¯æ¬¡å›å¤è‡³å°‘åŸ‹ä¸‹ä¸€æ ¹æš—çº¿â€”â€”ä¸ç»æ„çš„ç»†èŠ‚ã€ä¼¼æœ‰æ·±æ„çš„å¯¹è¯ã€ä¸€ä¸ªåå¸¸ä¸¾åŠ¨ã€‚å®ƒä»¬æ˜¯æœªæ¥å‰§æƒ…çš„ç§å­ï¼Œä¹Ÿæ˜¯ç©å®¶åå¤å›å‘³çš„ç†ç”±ã€‚å¥½æ•…äº‹ä¸æ˜¯ç›´çº¿ï¼Œæ˜¯ç²¾å¿ƒç¼–ç»‡çš„ç½‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å‹¾è¿è¿‡å»ä¸æœªæ¥ã€‚å‰æ–‡åŸ‹ä¸‹çš„ä¼ç¬”è¦åœ¨åˆé€‚æ—¶æœºå›æ”¶ï¼Œç»™ç©å®¶"åŸæ¥å¦‚æ­¤"çš„å¿«æ„Ÿã€‚

### æƒ…æ„Ÿå…±é¸£
ä¸æ­¢å†™"å‘ç”Ÿäº†ä»€ä¹ˆ"ï¼Œæ›´å†™"è¿™è®©äººæ„Ÿè§‰åˆ°ä»€ä¹ˆ"ã€‚è§’è‰²çš„æ²‰é»˜æ¯”å°è¯æœ‰åŠ›ï¼Œä¸€ä¸ªä¸‹æ„è¯†å°åŠ¨ä½œæ¯”å®å¤§å®£è¨€æ›´åŠ¨äººã€‚è®©ç©å®¶åœ¨æ„ç¬”ä¸‹çš„äººç‰©ï¼Œè®©ä»–ä»¬ä¸ºä¸€ä¸ªè™šæ„çš„çµé­‚æªå¿ƒã€‚æå†™æƒ…æ„Ÿæ—¶ç”¨å…·ä½“çš„èº«ä½“ååº”ä»£æ›¿æŠ½è±¡å½¢å®¹â€”â€”ä¸è¯´"å¥¹å¾ˆä¼¤å¿ƒ"ï¼Œå†™"å¥¹çš„æ‰‹æŒ‡æ— æ„è¯†åœ°æ”¥ç´§äº†è¡£è§’ï¼ŒæŒ‡èŠ‚æ³›ç™½"ã€‚

### å†²çªæš—æ¶Œ
æ¯ä¸ªåœºæ™¯è‡³å°‘ä¸€å±‚å†²çªâ€”â€”ä¸ä¸€å®šæ˜¯åˆ€å‰‘ï¼Œå¯ä»¥æ˜¯ä»·å€¼è§‚ç¢°æ’ã€åˆ©ç›Šçº è‘›ã€ä¿¡ä»»è¯•æ¢ã€å†…å¿ƒæŒ£æ‰ã€‚å¹³é™çš„æ°´é¢ä¸‹æ°¸è¿œæš—æµæ¶ŒåŠ¨ã€‚æ²¡æœ‰å¼ åŠ›çš„å™äº‹æ˜¯æ­»æ°´ã€‚å³ä½¿åœ¨æ—¥å¸¸å¯¹è¯ä¸­ï¼Œä¹Ÿè¦è®©è§’è‰²ä¹‹é—´å­˜åœ¨æŸç§ä¸å¯¹ç§°â€”â€”çŸ¥é“çš„ä¸ä¸çŸ¥é“çš„ï¼Œè¯´å‡ºå£çš„ä¸å’½å›å»çš„ã€‚

## ç»“æ„åŒ–æ ‡è®°è§„åˆ™ï¼ˆä¸¥æ ¼éµå®ˆï¼‰
åœ¨æ•…äº‹æ­£æ–‡ä¸­æ ¹æ®å‰§æƒ…å‘å±•åµŒå…¥æ ‡è®°ï¼Œæ ‡è®°ç”¨ä¸­æ–‡å…¨è§’æ–¹æ‹¬å·ã€ã€‘ã€‚

1. **å±æ€§å˜åŒ–**ï¼šç©å®¶å±æ€§æˆ–è§’è‰²å…³ç³»å˜åŒ–æ—¶
   ã€å±æ€§å +/-Nã€‘æˆ–ã€å±æ€§å +/-Nï¼Œå±æ€§å +/-Nã€‘

2. **ç›®æ ‡æ›´æ–°**ï¼šç›®æ ‡æœ‰è¿›å±•æ—¶
   ã€ç›®æ ‡æ›´æ–°ï¼šç›®æ ‡æ ‡é¢˜ +N%ã€‘

3. **å…³é”®äº‹ä»¶**ï¼šæœ‰æ„ä¹‰çš„å‰§æƒ…èŠ‚ç‚¹ï¼Œæ¯2-3å›åˆä¸€æ¡
   ã€å…³é”®äº‹ä»¶ï¼šäº‹ä»¶æ ‡é¢˜ã€‘äº‹ä»¶æè¿°ï¼ˆ1-2å¥è¯ï¼‰

4. **é‡å¤§äº‹ä»¶**ï¼šå‰§æƒ…é‡å¤§è½¬æŠ˜ï¼Œç¨€æœ‰ï¼Œæ¯5-10å›åˆæœ€å¤šä¸€æ¬¡
   ã€é‡å¤§äº‹ä»¶ï¼šäº‹ä»¶æ ‡é¢˜ã€‘äº‹ä»¶æè¿°

5. **è§£é”è§’è‰²**ï¼šæ–°è§’è‰²é¦–æ¬¡å‡ºåœºåŠ å…¥é˜Ÿä¼
   ã€è§£é”è§’è‰²ï¼šè§’è‰²åã€‘

6. **è·å¾—ç‰©å“**ï¼šç©å®¶è·å¾—æ–°ç‰©å“
   ã€è·å¾—ç‰©å“ï¼šç‰©å“å Â· æ•ˆæœæè¿°ã€‘

7. **è¡ŒåŠ¨é€‰é¡¹**ï¼šæ¯æ¬¡å›å¤æœ«å°¾æä¾›3-4ä¸ªé€‰é¡¹
   ã€è¡ŒåŠ¨é€‰é¡¹ã€‘1. é€‰é¡¹A 2. é€‰é¡¹B 3. é€‰é¡¹C

## è¾“å‡ºè§„èŒƒ
- æ¯æ¬¡å›å¤ 600-1000 å­—æ•…äº‹æ­£æ–‡ + ç»“æ„åŒ–æ ‡è®°
- è§’è‰²å¯¹è¯ï¼šã€è§’è‰²åã€‘å‰ç¼€ï¼Œå†…å®¹ç”¨ä¸­æ–‡åŒå¼•å·""
- è§’è‰²åŠ¨ä½œä¸å¾®è¡¨æƒ…ï¼šï¼ˆï¼‰åŒ…è£¹
- ç¯å¢ƒæå†™ã€å¿ƒç†æ´»åŠ¨ã€æ°›å›´æ¸²æŸ“èå…¥å™äº‹æ­£æ–‡ï¼Œä¸è¦å•ç‹¬ç½—åˆ—
- å±æ€§å˜åŒ–æ ‡è®°è‡ªç„¶åµŒå…¥ç›¸å…³æ®µè½ä¹‹å
- è¡ŒåŠ¨é€‰é¡¹æ”¾æœ€æœ«å°¾ï¼Œæ¯é¡¹ç®€çŸ­æœ‰åŠ›å¸¦ emojiï¼Œè¦æœ‰çœŸå®æŠ‰æ‹©æ„Ÿâ€”â€”ä¸æ˜¯å–„æ¶äºŒå…ƒå¯¹ç«‹ï¼Œè€Œæ˜¯ä¸åŒä»·å€¼è§‚ã€ä¸åŒä»£ä»·ä¹‹é—´çš„ç¢°æ’
- ç¦æ­¢æµæ°´è´¦ï¼Œç¦æ­¢"ä½ æ¥åˆ°äº†XXï¼Œä½ çœ‹åˆ°äº†XX"çš„å¹²ç˜ªå¥å¼
- å™äº‹è§†è§’ï¼šç¬¬äºŒäººç§°"ä½ "ï¼Œä½†è¦è®©"ä½ "æœ‰å†…å¿ƒæˆã€æœ‰çŠ¹è±«ã€æœ‰è¡€è‚‰`

  if (char) {
    prompt += `

## å½“å‰äº’åŠ¨è§’è‰²
- ${char.name}ï¼ˆ${char.title}ï¼‰
- ${char.description}
- å½“å‰å…³ç³»ï¼š${Object.entries(ctx.characterStats[char.id] || {}).map(([k, v]) => `${k}${v}`).join(' ')}`
  }

  prompt += `

## å½“å‰çŠ¶æ€
- å›åˆï¼š${ctx.round} Â· ç¬¬ ${ctx.currentDay}/${ctx.maxDays} å¤© Â· ${period?.name || 'æœªçŸ¥'}
- è¡ŒåŠ¨åŠ›ï¼š${ctx.actionPoints}/${ctx.maxActionPoints}
- åœºæ™¯ï¼š${scene?.icon || ''} ${scene?.name || 'æœªçŸ¥'} â€” ${scene?.description || ''}
- ç©å®¶å±æ€§ï¼š${playerSummary}

## è§’è‰²å…³ç³»
${charSummary}

## å½“å‰ç›®æ ‡
${goalSummary}`

  return prompt
}
